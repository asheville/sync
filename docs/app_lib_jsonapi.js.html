<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/lib/jsonapi.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ContactVerification.html">ContactVerification</a></li><li><a href="module-app_models_contactVerificationRequest-ContactVerificationRequest.html">ContactVerificationRequest</a></li><li><a href="module-app_models_contentType-ContentType.html">ContentType</a></li><li><a href="module-app_models_item-Item.html">Item</a></li><li><a href="module-app_models_job-Job.html">Job</a></li><li><a href="module-app_models_notificationRequest-NotificationRequest.html">NotificationRequest</a></li><li><a href="module-app_models_source-Source.html">Source</a></li><li><a href="module-app_models_status-Status.html">Status</a></li><li><a href="module-app_models_storage-Storage.html">Storage</a></li><li><a href="module-app_models_userSourceAuth-UserSourceAuth.html">UserSourceAuth</a></li><li><a href="module-app_models_userStorageAuth-UserStorageAuth.html">UserStorageAuth</a></li><li><a href="module-app_models_user-User.html">User</a></li></ul><h3>Modules</h3><ul><li><a href="module-app_config_mongodb.html">app/config/mongodb</a></li><li><a href="module-app_config_session.html">app/config/session</a></li><li><a href="module-app_controllers_item.html">app/controllers/item</a><ul class='methods'><li data-type='method'><a href="module-app_controllers_item.html#.getResource">getResource</a></li><li data-type='method'><a href="module-app_controllers_item.html#.hasSupportedMediaType">hasSupportedMediaType</a></li><li data-type='method'><a href="module-app_controllers_item.html#.itemDataObjectsFromPage">itemDataObjectsFromPage</a></li><li data-type='method'><a href="module-app_controllers_item.html#.itemsGetUrl">itemsGetUrl</a></li><li data-type='method'><a href="module-app_controllers_item.html#.itemsPageError">itemsPageError</a></li><li data-type='method'><a href="module-app_controllers_item.html#.itemsPageNextPagination">itemsPageNextPagination</a></li><li data-type='method'><a href="module-app_controllers_item.html#.persistItemDataObject">persistItemDataObject</a></li><li data-type='method'><a href="module-app_controllers_item.html#.storagePath">storagePath</a></li><li data-type='method'><a href="module-app_controllers_item.html#.storeAllForUserStorageSource">storeAllForUserStorageSource</a></li><li data-type='method'><a href="module-app_controllers_item.html#.storeAllForUserStorageSourceContentType">storeAllForUserStorageSourceContentType</a></li><li data-type='method'><a href="module-app_controllers_item.html#.storeFile">storeFile</a></li><li data-type='method'><a href="module-app_controllers_item.html#.storeItemData">storeItemData</a></li><li data-type='method'><a href="module-app_controllers_item.html#.storeItemsPage">storeItemsPage</a></li><li data-type='method'><a href="module-app_controllers_item.html#.totalItemsAvailableFromPage">totalItemsAvailableFromPage</a></li></ul></li><li><a href="module-app_factories_model.html">app/factories/model</a><ul class='methods'><li data-type='method'><a href="module-app_factories_model.html#.new">new</a></li></ul></li><li><a href="module-app_index.html">app/index</a></li><li><a href="module-app_lib_assertions_functionCallbacksError.html">app/lib/assertions/functionCallbacksError</a></li><li><a href="module-app_lib_assertions_functionCallbacksNoError.html">app/lib/assertions/functionCallbacksNoError</a></li><li><a href="module-app_lib_assertions_functionCallbacksResult.html">app/lib/assertions/functionCallbacksResult</a></li><li><a href="module-app_lib_assertions_functionReturnsResult.html">app/lib/assertions/functionReturnsResult</a></li><li><a href="module-app_lib_assertions_functionThrowsError.html">app/lib/assertions/functionThrowsError</a></li><li><a href="module-app_lib_assertions_functionThrowsNoError.html">app/lib/assertions/functionThrowsNoError</a></li><li><a href="module-app_lib_assertions_index.html">app/lib/assertions/index</a></li><li><a href="module-app_lib_assertions_it.html">app/lib/assertions/it</a><ul class='methods'><li data-type='method'><a href="module-app_lib_assertions_it.html#~compiledDescription">compiledDescription</a></li></ul></li><li><a href="module-app_lib_assertions_objectHasProperties.html">app/lib/assertions/objectHasProperties</a></li><li><a href="module-app_lib_assertions_objectHasProperty.html">app/lib/assertions/objectHasProperty</a></li><li><a href="module-app_lib_assertions_objectMethodReturnsResult.html">app/lib/assertions/objectMethodReturnsResult</a></li><li><a href="module-app_lib_assertions_objectSavesAndHasProperties.html">app/lib/assertions/objectSavesAndHasProperties</a></li><li><a href="module-app_lib_assertions_objectToObjectMethodReturnsProperties.html">app/lib/assertions/objectToObjectMethodReturnsProperties</a></li><li><a href="module-app_lib_assertions_result.html">app/lib/assertions/result</a></li><li><a href="module-app_lib_assertions_route.html">app/lib/assertions/route</a></li><li><a href="module-app_lib_createPopulatedProperties.html">app/lib/createPopulatedProperties</a></li><li><a href="module-app_lib_debug.html">app/lib/debug</a></li><li><a href="module-app_lib_factory.html">app/lib/factory</a></li><li><a href="module-app_lib_jsonapi.html">app/lib/jsonapi</a><ul class='methods'><li data-type='method'><a href="module-app_lib_jsonapi.html#.allowed">allowed</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.compiledQueryConditions">compiledQueryConditions</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.modelQueryConditions">modelQueryConditions</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeModelDeleteObjectResource">routeModelDeleteObjectResource</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeModelGetObjectResource">routeModelGetObjectResource</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeModelGetObjectsResource">routeModelGetObjectsResource</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeModelPatchObjectResource">routeModelPatchObjectResource</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeModelPostObjectResource">routeModelPostObjectResource</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeModelResource">routeModelResource</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeModelResources">routeModelResources</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.routeResource">routeResource</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.saveRelationshipsToDocument">saveRelationshipsToDocument</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.validateQueryData">validateQueryData</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.validateRequestBody">validateRequestBody</a></li><li data-type='method'><a href="module-app_lib_jsonapi.html#.validateRequestUrl">validateRequestUrl</a></li></ul></li><li><a href="module-app_lib_logger.html">app/lib/logger</a><ul class='methods'><li data-type='method'><a href="module-app_lib_logger.html#.req">req</a></li><li data-type='method'><a href="module-app_lib_logger.html#.scopedLog">scopedLog</a></li></ul></li><li><a href="module-app_lib_request.html">app/lib/request</a></li><li><a href="module-app_lib_unpopulatedProperties.html">app/lib/unpopulatedProperties</a></li><li><a href="module-app_lib_warehouse.html">app/lib/warehouse</a><ul class='methods'><li data-type='method'><a href="module-app_lib_warehouse.html#.itemDataObject">itemDataObject</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.itemDataObjects">itemDataObjects</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.itemPage">itemPage</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.itemPages">itemPages</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.itemRelationships">itemRelationships</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.many">many</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.manySaved">manySaved</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.mockProperties">mockProperties</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.one">one</a></li><li data-type='method'><a href="module-app_lib_warehouse.html#.oneSaved">oneSaved</a></li></ul></li><li><a href="module-app_models_contactVerification.html">app/models/contactVerification</a></li><li><a href="module-app_models_contactVerificationRequest.html">app/models/contactVerificationRequest</a></li><li><a href="module-app_models_contentType.html">app/models/contentType</a></li><li><a href="module-app_models_index.html">app/models/index</a></li><li><a href="module-app_models_item.html">app/models/item</a></li><li><a href="module-app_models_job.html">app/models/job</a></li><li><a href="module-app_models_notificationRequest.html">app/models/notificationRequest</a></li><li><a href="module-app_models_source.html">app/models/source</a></li><li><a href="module-app_models_status.html">app/models/status</a></li><li><a href="module-app_models_storage.html">app/models/storage</a><ul class='methods'><li data-type='method'><a href="module-app_models_storage.html#headers">headers</a></li><li data-type='method'><a href="module-app_models_storage.html#itemPutUrl">itemPutUrl</a></li></ul></li><li><a href="module-app_models_user.html">app/models/user</a></li><li><a href="module-app_models_userSourceAuth.html">app/models/userSourceAuth</a></li><li><a href="module-app_models_userStorageAuth.html">app/models/userStorageAuth</a></li><li><a href="module-app_server.html">app/server</a></li><li><a href="module-Gruntfile.html">Gruntfile</a></li><li><a href="module-tests_app.html">tests/app</a></li><li><a href="module-tests_models.html">tests/models</a></li><li><a href="module-tests_routers.html">tests/routers</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">app/lib/jsonapi.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Generates routes conformant to the JSON API specification for Mongoose models
 * @module
 */

var _ = require('lodash');
var async = require('async');
var bodyParser = require('body-parser');
var debug = require('debug')('syncServer:jsonapi');
var models = require('app/models');
var ObjectId = require('mongoose').Types.ObjectId;
var validateParams = require('./validateParams');

module.exports = {
  /**
   * Returns allowed requester type value for model and method
   * @param {Object} model - Mongoose model
   * @param {string} method - HTTP method
   * @returns {string} allowed value (e.g. "public", "user", or "admin)
   */
  allowed: function(model, method) {
    if (typeof model.jsonapi[method] === 'string') {
      return model.jsonapi[method];
    } else if (typeof model.jsonapi[method] === 'object') {
      return model.jsonapi[method].allowed;
    }
  },

  /**
   * Callbacks Mongoose query conditions compiled from two separate conditions
   * Primary conditions are passed as parameter "conditions"
   * Secondary conditions are determined from model using route name
   * @param {Object} req - Express request object
   * @param {Object} conditions - Primary query conditions
   * @param {Object} model - Mongoose model (optional)
   * @param {string} method - HTTP method (optional)
   * @param {callback} done
   */
  compiledQueryConditions: function myself(req, conditions, model, method, done) {
    this.modelQueryConditions(req, model, method, (error, modelConditions) => {
      done(error, Object.assign({}, modelConditions, conditions));
    });
  },

  /**
   * Callbacks a model's query conditions given request user status
   * @param {Object} req - Express request object
   * @param {Object} model - Mongoose model
   * @param {string} method - HTTP method (optional)
   * @param {callback} done
   */
  modelQueryConditions: function(req, model, method, done) {
    validateParams([{
      name: 'req', variable: req, required: true
    }, {
      name: 'model', variable: model, required: true, requiredProperties: ['jsonapi']
    }, {
      name: 'method', variable: method, required: true
    }]);

    debug('modelQueryConditions %s, %s', model.modelId(), method);

    if (model.jsonapi[method] &amp;&amp; model.jsonapi[method].queryConditions) {
      var queryConditions = model.jsonapi[method].queryConditions;

      if (typeof queryConditions === 'object' &amp;&amp; (queryConditions.public || queryConditions.user || queryConditions.admin)) {
        if (!req.user &amp;&amp; queryConditions.public) {
          done(undefined, queryConditions.public);
        } else if (req.user &amp;&amp; req.user.admin &amp;&amp; queryConditions.admin) {
          done(undefined, queryConditions.admin);
        } else if (req.user &amp;&amp; !req.user.admin &amp;&amp; queryConditions.user) {
          done(undefined, queryConditions.user);
        }
      } else if (typeof queryConditions === 'function') {
        model.jsonapi[method].queryConditions(req, done);
      } else {
        done(undefined, queryConditions);
      }
    } else {
      done(undefined, {});
    }
  },

  /**
   * Routes DELETE requests to resource for individual resource objects for app and Model
   * @param {Object} app - Express app
   * @param {Object} Model - Mongoose model
   */
  routeModelDeleteObjectResource: function(app, Model) {
    this.routeModelResource(app, Model, 'delete', '/' + Model.modelType() + '/:id', (req, res) => {
      var getConditions = (done) => {
        this.compiledQueryConditions(req, { _id: req.params.id }, Model, 'delete', done);
      };

      var findOne = (conditions, done) => {
        Model.findOne(conditions, done);
      };

      async.waterfall([getConditions, findOne], function(error, document) {
        if (error) {
          res.sendError(error);
        } else if (!document) {
          res.sendNotFound();
        } else {
          document.remove(function(error) {
            if (error) {
              res.status(500).send();
            } else {
              res.status(204).send();
            }
          });
        }
      });
    });
  },

  /**
   * Routes GET requests to resource for individual resource objects for app and model
   * @param {Object} app - Express app
   * @param {model} model - Mongoose model
   */
  routeModelGetObjectResource: function(app, model) {
    this.routeModelResource(app, model, 'get', '/' + model.modelType() + '/:id', (req, res) => {
      var getConditions = (done) => {
        this.compiledQueryConditions(req, { _id: req.params.id }, model, 'get', done);
      };

      var findOne = (conditions, done) => {
        debug('GET findOne %O', conditions);
        model.findOne(conditions, done);
      };

      async.waterfall([getConditions, findOne], function(error, document) {
        if (error) {
          logger.error('Resource router failed to query for object', { model: model.modelName, error: error.message });
          res.sendError();
        } else if (!document) {
          res.sendNotFound();
        } else {
          res.sendDocument(document);
        }
      });
    });
  },

  /**
   * Routes GET requests to resource for collections of resource objects for app and model
   * @param {Object} app - Express app
   * @param {model} model - Mongoose model
   */
  routeModelGetObjectsResource: function(app, model) {
    this.routeModelResource(app, model, 'get', '/' + model.modelType(), (req, res) => {
      var compileConditions = (done) => {
        var conditions = this.compiledQueryConditions(req, {}, model, 'get', done);
      };

      var executeQuery = (conditions, done) => {
        var cursor = req.query.page &amp;&amp; req.query.page.cursor ? req.query.page.cursor : null;
        var limit = req.query.page &amp;&amp; req.query.page.limit ? req.query.page.limit : 25;
        var query = model.find(conditions);
        var supportedSortAttributes = ['_id' , 'createdAt', 'updatedAt'];

        debug('GET %O', conditions);

        if (req.query.sort) {
          var sortOrder = 1;
          var sortAttributes = req.query.sort;
          var unsupportedSortAttributeFound = false;

          sortAttributes.split(',').forEach(function(sortAttribute) {
            var absoluteSortAttribute;

            if (sortAttribute.charAt(0) === '-') {
              absoluteSortAttribute = sortAttribute.substring(1);
            } else {
              absoluteSortAttribute = sortAttribute;
            }

            if (supportedSortAttributes.indexOf(absoluteSortAttribute) === -1) {
              unsupportedSortAttributeFound = true;
            }
          });

          if (unsupportedSortAttributeFound) {
            return res.status(400).send('Unsupported sort attribute provided');
          }

          query.sort(sortAttributes.replace(',', ' '));
        } else {
          query.sort({ createdAt: -1 });
        }

        if (cursor) {
          query.where('_id').lt(cursor);
        }

        query.limit(limit);
        query.exec(done);
      };

      async.waterfall([compileConditions, executeQuery], function(error, documents) {
        if (error) {
          logger.error('Resource router failed to query for objects', { model: model.modelName, error: error.message });
          res.sendError();
        } else {
          res.sendDocuments(documents);
        }
      });
    });
  },

  /**
   * Routes POST requests to resource for individual resource objects for app and Model
   * @param {Object} app - Express app
   * @param {Object} Model - Mongoose model
   */
  routeModelPatchObjectResource: function(app, Model) {
    this.routeModelResource(app, Model, 'patch', '/' + Model.modelType() + '/:id', (req, res) => {
      var validate = (done) => {
        this.validateQueryData(req, req.body.data, Model, 'patch', done);
      };

      var getConditions = (done) => {
        this.compiledQueryConditions(req, { _id: req.params.id }, Model, 'patch', done);
      };

      var findOneAndUpdate = (conditions, done) => {
        Model.findOneAndUpdate(conditions, req.body.data.attributes, { new: true }, done);
      };

      var addRelationships = (document, done) => {
        if (!document) {
          return done(new Error('No document found with ID'));
        }

        if (!req.body.data.relationships) {
          return done(undefined, document);
        }

        this.saveRelationshipsToDocument(document, req.body.data.relationships, function(error) {
          done(error, document);
        });
      };

      var saveDocument = (document, done) => {
        document.save((error) => {
          done(error, document);
        });
      };

      var executePostRoutine = (document, done) => {
        if (Model.jsonapi.patch &amp;&amp; Model.jsonapi.patch.post) {
          Model.jsonapi.patch.post(req, res, document, function(error, req, res, document) {
            done(error, document);
          });
        } else {
          done(undefined, document);
        }
      };

      async.waterfall([
        validate,
        getConditions,
        findOneAndUpdate,
        addRelationships,
        saveDocument,
        executePostRoutine
      ], function(error, document) {
        if (error) {
          if (error.errors) {
            return res.sendError(error, 400);
          }

          if (error.message === 'No document found with ID') {
            res.sendNotFound();
          } else {
            res.sendError(error, 500);
          }
        } else {
          res.sendDocument(document, 200);
        }
      });
    });
  },

  /**
   * Routes POST requests to resource for individual resource objects for app and Model
   * @param {Object} app - Express app
   * @param {Object} Model - Mongoose model
   */
  routeModelPostObjectResource: function(app, Model) {
    this.routeModelResource(app, Model, 'post', '/'+ Model.modelType(), (req, res) => {
      /**
       * Validates all available attributes (TODO: and relationships)
       */
      var validate = (done) => {
        debug('POST validate');
        this.validateQueryData(req, req.body.data, Model, 'post', done);
      };

      /**
       * Creates the document with all available attributes
       */
      var createDocument = (done) => {
        debug('POST createDocument');

        try {
          var document = new Model(req.body.data.attributes);
        } catch (error) {
          return done(error);
        }

        done(undefined, document);
      };

      /**
       * Adds all available relationships to document
       */
      var addRelationships = (document, done) => {
        if (!req.body.data.relationships) {
          return done(undefined, document);
        }

        this.saveRelationshipsToDocument(document, req.body.data.relationships, function(error) {
          done(error, document);
        });
      };

      /**
       * Saves the document
       */
      var saveDocument = (document, done) => {
        document.save((error) => {
          done(error, document);
        });
      };

      /**
       * Reloads the document to ensure all autopopulate references are populated
       */
      var reloadDocument = (document, done) => {
        Model.findById(document.id, (error, document) => {
          done(error, document);
        });
      }

      /**
       * Executes any available post-POST routine available for Model
       */
      var executePostRoutine = (document, done) => {
        if (Model.jsonapi.post &amp;&amp; Model.jsonapi.post.post) {
          Model.jsonapi.post.post(req, res, document, function(error) {
            done(error, document);
          });
        } else {
          done(undefined, document);
        }
      };

      async.waterfall([
        validate,
        createDocument,
        addRelationships,
        saveDocument,
        reloadDocument,
        executePostRoutine
      ], function(error, document) {
        if (error) {
          if (error.errors) {
            return res.sendError(error, 400);
          }

          return res.sendError(error);
        }

        res.sendDocument(document, 201);
      });
    });
  },

  /**
   * Routes requests to resource callback for app, model, method and path
   * @param {Object} app - Express app
   * @param {model} model - Mongoose model
   * @param {string} method - HTTP method (lowercase, e.g "get")
   * @param {string} path - Path to resource
   * @param {function} done - Express route callback expecting req and res as parameters
   */
  routeModelResource: function(app, model, method, path, done) {
    if (!model.jsonapi || !model.jsonapi[method]) { return; }

    var validateRequestBody = false;

    if (['patch', 'post'].indexOf(method) !== -1) {
      validateRequestBody = this.validateRequestBody(model);
    }

    var middleware = {
      requireAuthentication: (['public'].indexOf(this.allowed(model, method)) === -1),
      requireAdminAuthentication: (['public', 'user'].indexOf(this.allowed(model, method)) === -1),
      validateRequestBody: validateRequestBody
    }

    this.routeResource(app, method, path, middleware, done);
  },

  /**
   * Establish middleware that generates routes conformant to the JSON API specification for app and Mongoose models
   * @param {Object} app - Express app
   */
  routeModelResources: function(app) {
    /**
     * Negotiate the Content-Type and Accept request headers
     * @see {@link http://jsonapi.org/format/#content-negotiation-servers}
     */
    app.use(function(req, res, next) {
      var isModifiedContentType = function(contentType) {
        return (/application\/vnd\.api\+json/.test(contentType) &amp;&amp; contentType !== 'application/vnd.api+json');
      };

      if (req.get('Content-Type') &amp;&amp; isModifiedContentType(req.get('Content-Type'))) {
        res.sendStatus(415);
        return;
      };

      if (req.get('Accept')) {
        var badAccept = false;
        req.get('Accept').split(';').forEach(function(accept) {
          badAccept = (isModifiedContentType(accept));
        });

        if (badAccept) {
          res.sendStatus(406);
          return;
        }
      }

      next();
    });

    app.use(function(req, res, next) {
      res.set('Content-Type', 'application/vnd.api+json');

      /**
       * Returns JSON API resource object representing provided Mongoose document
       * Document properties filtered out per model settings
       * @param {Object} document - Mongoose document
       * @returns {Object} object - JSON API resource object
       */
      res.resourceObjectFromDocument = function(document) {
        if (!document) {
          throw new Error('No document provided');
        }

        var attributes = document.toObject();
        var Model = models[document.modelId()];

        delete attributes.id;

        var relationships = {};

        Object.keys(attributes).forEach(function(key) {
          var addRelationship = function(value) {
            if (value &amp;&amp; value._id &amp;&amp; value.modelType) {
              if (!relationships[key] || !relationships[key].data) {
                if (Array.isArray(document[key])) {
                  relationships[key] = { data: [] };
                } else {
                  relationships[key] = { data: {} };
                }
              }

              if (Array.isArray(document[key])) {
                relationships[key].data.push({
                  id: value._id,
                  type: value.modelType()
                });
              } else {
                relationships[key].data = {
                  id: value._id,
                  type: value.modelType()
                };
              }

              delete attributes[key];
            }
          };

          if (Array.isArray(document[key])) {
            if (document[key].length &lt; 1) {
              delete attributes[key];
            } else {
              document[key].forEach(addRelationship);
            }
          } else {
            addRelationship(document[key]);
          }
        });

        if (Model.jsonapi.filterProperties) {
          Model.jsonapi.filterProperties.forEach((name) => {
            delete attributes[name];
          });
        }

        return {
          id: document.id,
          type: document.modelType(),
          attributes: attributes,
          relationships: Object.getOwnPropertyNames(relationships).length > 0 ? relationships : undefined
        };
      };

      /**
       * Returns JSON API resource identifier object representing provided Mongoose document
       * @param {Object} document - Mongoose document
       * @returns {Object} object - JSON API relationship object
       */
      res.resourceIdentifierObjectFromDocument = function(document, name) {
        if (!document) {
          throw new Error('No document provided');
        }

        return {
          id: document.id,
          type: document.modelType()
        };
      };

      /**
       * Add document as relationship to JSON API resource object
       * @param {Object} object - JSON API resource object
       * @param {Object} document - Mongoose document
       * @param {string} name - Name of relationship (e.g. "author")
       * @param {string} [type=to-many] - Type of relationship (either "to-many" or "to-one")
       */
      res.addRelationshipToResourceObject = function(object, document, name, type) {
        validateParams([{
          name: 'object', variable: object, required: true, requiredType: 'object'
        }, {
          name: 'document', variable: document, required: true, requiredType: 'object'
        }, {
          name: 'name', variable: name, required: true, requiredType: 'string'
        }, {
          name: 'type', variable: type, requiredType: 'string'
        }]);

        if (!object.relationships) {
          object.relationships = {};
        }

        type = type ? type : 'to-many';

        if (type === 'to-many') {
          if (!Array.isArray(object.relationships[name])) {
            object.relationships[name] = [];
          }

          object.relationships[name].push(res.resourceIdentifierObjectFromDocument(document));
        } else if (type === 'to-one') {
          object.relationships[name] = this.resourceIdentifierObjectFromDocument(document);
        } else {
          throw new Error('Type parameter is not valid');
        }
      };

      /**
       * Sends response document with principal data, included resources or errors
       * @param {Object} data – Principal data (optional)
       * @param {Object} included – Included resources (optional)
       * @param {Object} errors - Errors (optional)
       * @param {number} [status=200] - HTTP status code
       */
      res.sendResponseDocument = function(data, included, errors, status) {
        var doc = {};

        if (data) {
          doc['data'] = data;

          if (included &amp;&amp; (!Array.isArray(included) || included.length > 0)) {
            doc['included'] = included;
          }
        } else if (errors) {
          doc['errors'] = errors;
        }

        doc['jsonapi'] = {
          version: '1.0'
        };

        if (!status) {
          status = 200;
        }

        this.status(status).json(doc);
      };

      /**
       * Sends response document with principal data and included resources
       * @param {Object} data – Principal data
       * @param {Object} included – Included resources (optional)
       */
      res.sendData = function(data, included) {
        if (!data) {
          throw new Error('No data parameter provided');
        }

        this.sendResponseDocument(data, included);
      };

      /**
       * Sends response document with model document
       * @param {Object} document - Model document
       * @param {number} status - HTTP status code
       */
      res.sendDocument = function(document, status) {
        res.sendResponseDocument(this.resourceObjectFromDocument(document), null, null, status);
      };

      /**
       * Sends response document with model documents
       * @param {Object} documents - Array of model documents
       */
      res.sendDocuments = function(documents) {
        var objects = documents.map((document) => {
          return this.resourceObjectFromDocument(document);
        });

        res.sendResponseDocument(objects);
      };

      /**
       * Sends response document with 404 status code
       */
      res.sendNotFound = function() {
        res.sendResponseDocument(null, null, null, 404);
      }

      /**
       * Sends response document with error and status code
       * @param {Error} error - Error object (optional) with optional errors property
       * @param {number} [status=500] - HTTP status code
       */
      res.sendError = function(error, status) {
        if (error) {
          var errors = error.errors;

          if (!errors) {
            errors = new Array(error);
          }

          // Convert object of errors to array if needed
          if(typeof errors === 'object' &amp;&amp; !Array.isArray(errors)) {
            errors = Object.keys(errors).map(function(key) {
              return errors[key];
            });
          }

          errors = errors.map(function(error) {
            return {
              title: error.message
            };
          });
        }

        if (!status) {
          status = 500;
        }

        this.sendResponseDocument(null, null, errors, status);
      };

      next();
    });

    /**
     * Establish body-parser middleware with JSON API error handling
     */
    app.use(function(req, res, next) {
      var json = bodyParser.json();

      json(req, res, function(error) {
        if (error) {
          res.sendError(error, 400);
        } else {
          next();
        }
      });
    });

    app.get('/', function(req, res) {
      res.sendResponseDocument();
    });

    // Route requests for each model with Mongoose compatability and jsonapi configuration
    Object.keys(models).forEach((key) => {
      var model = models[key];
      
      if (model.modelName &amp;&amp; model.jsonapi) {
        this.routeModelGetObjectsResource(app, model);
        this.routeModelGetObjectResource(app, model);
        this.routeModelPostObjectResource(app, model);
        this.routeModelPatchObjectResource(app, model);
        this.routeModelDeleteObjectResource(app, model);
      }
    });
  },

  /**
   * Routes requests to resource callback for app, method, path and middleware
   * @param {Object} app - Express app
   * @param {string} method - HTTP method (lowercase, e.g "get")
   * @param {string} path - Path to resource
   * @param {Object} middleware - Dictionary of middleware boolean or function values to use for route
   * @param {function} done - Express route callback expecting req and res as parameters
   */
  routeResource: function(app, method, path, middleware, done) {
    var requireAuthentication = (req, res, next) => {
      if (middleware &amp;&amp; middleware.requireAuthentication) {
        app.requireAuthentication(req, res, next);
      } else {
        next();
      }
    };

    var requireAdminAuthentication = (req, res, next) => {
      if (middleware &amp;&amp; middleware.requireAdminAuthentication) {
        app.requireAdminAuthentication(req, res, next);
      } else {
        next();
      }
    };

    var validateRequestUrl = (req, res, next) => {
      if (!middleware || middleware.validateRequestUrl !== false) {
        this.validateRequestUrl(req, res, next);
      } else {
        next();
      }
    };

    var validateRequestBody = (req, res, next) => {
      if (middleware &amp;&amp; middleware.validateRequestBody &amp;&amp; typeof middleware.validateRequestBody === 'function') {
        middleware.validateRequestBody(req, res, next);
      } else if (middleware &amp;&amp; middleware.validateRequestBody) {
        this.validateRequestBody()(req, res, next);
      } else {
        next();
      }
    };

    app[method](path, requireAuthentication, requireAdminAuthentication, validateRequestUrl, validateRequestBody, done);
  },

  /**
   * Saves all provided relationships to document
   * @param {Object} document - Mongoose document
   * @param {Object} document - Key-value object of relationships
   * @param {callback} done
   */
  saveRelationshipsToDocument: function(document, relationships, done) {
    var validate = function(done) {
      validateParams([{
        name: 'document', variable: document, required: true, requiredType: ['object', 'constructor']
      }, {
        name: 'relationships', variable: relationships, required: true, requiredType: ['object']
      }, {
        name: 'done', variable: done, required: true, requiredType: ['function']
      }], done);
    };

    var saveRelationshipsToDocument = function(done) {
      var Model = models[document.modelId()];
      
      async.forEachOf(relationships, function(relationship, relationshipName, done) {
        var validateRelationship = function(done) {
          var errors = [];

          if (!relationship.data) {
            errors.push(new Error(`Relationship "${relationshipName}" does not have data property`));
          }

          if (!Model.schema.tree[relationshipName]) {
            errors.push(new Error(`Relationship name "${relationshipName}" is not valid`));
          } else if (Array.isArray(Model.schema.tree[relationshipName]) &amp;&amp; !Model.schema.tree[relationshipName][0].ref) {
            errors.push(new Error(`Relationship name "${relationshipName}"is not valid`));
          } else if (!Array.isArray(Model.schema.tree[relationshipName]) &amp;&amp; (typeof Model.schema.tree[relationshipName] !== 'object' || !Model.schema.tree[relationshipName].ref)) {
            errors.push(new Error(`Relationship name "${relationshipName}"is not valid`));
          }

          if (Array.isArray(Model.schema.tree[relationshipName]) &amp;&amp; !Array.isArray(relationship.data)) {
            errors.push(new Error(`Relationship data should not be an array given name "${relationshipName}"`));
          }

          if (!Array.isArray(relationship.data) &amp;&amp; Array.isArray(Model.schema.tree[relationshipName])) {
            errors.push(new Error(`Relationship data should be an array given name "${relationshipName}"`));
          }

          if (errors.length > 0) {
            var error = new Error(`Relationship "${relationshipName}" is not properly formatted`);
            error.errors = errors;
          }

          done(error);
        };

        var addRelationshipToDocument = function(done) {
          var validateAndAddResourceIdentifierObjectRelationship = function(resourceObject, done) {
            var validateResourceIdentifierObject = function(done) {
              var errors = [];

              if (!resourceObject.id) {
                errors.push(new Error(`Relationship resource identifier object for "${relationshipName}" does not have id property`));
              }

              if (!resourceObject.type) {
                errors.push(new Error(`Relationship resource identifier object for "${relationshipName}" does not have type property`));
              }

              if (Array.isArray(Model.schema.tree[relationshipName])) {
                var ref = Model.schema.tree[relationshipName][0].ref;
              } else {
                var ref = Model.schema.tree[relationshipName].ref;
              }

              if (models[_.lowerFirst(ref)].modelType() !== resourceObject.type) {
                errors.push(new Error(`Relationship resource identifier object type "${resourceObject.type}" is not valid`));
              }

              if (!ObjectId.isValid(resourceObject.id)) {
                errors.push(new Error(`Relationship resource identifier object ID "${resourceObject.id}" is not valid`));
              }

              if (errors.length > 0) {
                var error = new Error(`Relationship resource identifier object is not properly formatted`);
                error.errors = errors;
              }

              done(error);
            };

            var addResourceIdentifierToDocument = function(done) {
              if (Array.isArray(Model.schema.tree[relationshipName]) &amp;&amp; document[relationshipName].indexOf(resourceObject.id) === -1) {
                document[relationshipName].push(resourceObject.id);
              } else if (!Array.isArray(Model.schema.tree[relationshipName])) {
                document[relationshipName] = resourceObject.id;
              }

              done();
            };

            async.series([validateResourceIdentifierObject, addResourceIdentifierToDocument], function(error) {
              done(error, document);
            });
          };

          if (Array.isArray(relationship.data)) {
            async.forEach(relationship.data, validateAndAddResourceIdentifierObjectRelationship, done);
          } else {
            validateAndAddResourceIdentifierObjectRelationship(relationship.data, done);
          }
        };

        async.series([validateRelationship, addRelationshipToDocument], done);
      }, done);
    };

    async.series([validate, saveRelationshipsToDocument], function(error) {
      done(error, document);
    });
  },

  /**
   * Callbacks error with array of validation errors if query data do not conform to model's value restrictions given requester's status (e.g. public, user, admin)
   * @param {Object} req - Express request object
   * @param {Object} data - Query data
   * @param {Object} model - Mongoose model (optional)
   * @param {string} method - HTTP method (optional)
   * @param {function} done - Error-first callback function expecting no other parameters
   */
  validateQueryData: function(req, data, model, method, done) {
    var getConditions = (done) => {
      this.modelQueryConditions(req, model, method, done);
    };

    var validateQueryData = (conditions, done) => {
      var errors = [];

      Object.keys(conditions).forEach(function(key) {
        try {
          var isEqualObjectId = ObjectId(_.get(data, `relationships.${key}.data.id`)).equals(conditions[key]);
        } catch (error) {
          var isEqualObjectId = false;
        }
        
        if (conditions[key] !== data.attributes[key] &amp;&amp; !isEqualObjectId) {
          errors.push(new Error(`Value for attribute ${key} invalid`));
        }
      });

      if (errors.length > 0) {
        var error = new Error('Query data invalid');
        error.errors = errors;

        return done(error);
      }

      done();
    };

    async.waterfall([getConditions, validateQueryData], done);
  },

  /**
   * Returns Express route middleware that validates request body against JSON API specification and URL for optional model
   * @param {Object} model - Mongoose model (optional)
   */
  validateRequestBody: function(model) {
    return function(req, res, next) {
      var errors = [];

      if (typeof req.body.data === 'undefined') {
        errors.push(new Error('Data value not provided top-level in body of request'));
      } else {
        if (typeof req.body.data.attributes === 'undefined') {
          errors.push(new Error('Attributes value not provided within data value of request'));
        }

        if (typeof req.body.data.type === 'undefined') {
          errors.push(new Error('Type value not provided within data value of request'));
        } else if (model &amp;&amp; req.body.data.type !== model.modelType()) {
          errors.push(new Error('Type value provided within data value of request does not match type indicated by URL'));
        }

        if (req.params.id &amp;&amp; !req.body.data.id) {
          errors.push(new Error('ID value not provided within data value of request'));
        } else if (req.params.id &amp;&amp; req.body.data.id !== req.params.id) {
          errors.push(new Error('ID value provided within data value of request does not match ID indicated by URL'));
        }
      }

      if (errors.length > 0) {
        var error = new Error('Failed to validate request body');
        error.errors = errors;
        res.sendError(error, 400);
      } else {
        next();
      }
    };
  },

  /**
   * Validates request URL against Mongoose needs
   */
  validateRequestUrl: function(req, res, next) {
    if (req.params.id &amp;&amp; !req.params.id.match(/^[0-9a-fA-F]{24}$/)) {
      res.sendError(new Error('Resource ID indicated with invalid format in URL'), 400);
    } else {
      next();
    }
  }
};</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Mar 06 2017 18:53:04 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
